<!DOCTYPE html>
<html lang="pt">
<head>
	<meta charset="UTF-8">
	<title>Lista de Imóveis</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<style>
		body {
			margin: 0;
			font-family: 'Segoe UI', sans-serif;
			display: flex;
			height: 100vh;
			overflow: hidden;
		}

		.sidebar {
			width: 400px;
			background: #f8f9fa;
			border-right: 1px solid #ddd;
			display: flex;
			flex-direction: column;
			box-shadow: 2px 0 5px rgba(0,0,0,0.1);
			z-index: 1000;
		}

		.header {
			padding: 20px;
			background: #343a40;
			color: white;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

			.header h2 {
				margin: 0;
				font-size: 18px;
			}

		.btn-add {
			background: #28a745;
			color: white;
			text-decoration: none;
			padding: 8px 15px;
			border-radius: 4px;
			font-size: 14px;
			font-weight: bold;
			display: inline-block;
		}

			.btn-add:hover {
				background: #218838;
			}

		.list-container {
			flex: 1;
			overflow-y: auto;
			padding: 15px;
		}

		.card {
			background: white;
			padding: 15px;
			margin-bottom: 15px;
			border-radius: 8px;
			border: 1px solid #eee;
			cursor: pointer;
			transition: 0.2s;
		}

			.card:hover {
				transform: translateY(-3px);
				box-shadow: 0 4px 12px rgba(0,0,0,0.1);
				border-color: #007bff;
			}

		.tag-type {
			background: #e9ecef;
			color: #495057;
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 11px;
			text-transform: uppercase;
			font-weight: bold;
		}

		.card-price {
			float: right;
			color: #28a745;
			font-weight: bold;
			font-size: 18px;
		}

		.card-addr {
			font-weight: bold;
			font-size: 15px;
			margin: 10px 0 5px 0;
			color: #333;
			line-height: 1.4;
		}

		.card-meta {
			font-size: 13px;
			color: #666;
			display: flex;
			gap: 10px;
			margin-bottom: 8px;
		}

		.card-desc {
			font-size: 12px;
			color: #888;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		#map {
			flex: 1;
			height: 100%;
			z-index: 1;
		}
	</style>
</head>
<body>

	<div class="sidebar">
		<div class="header">
			<h2>Imobiliária</h2>
			<a href="CreateProperty.html" class="btn-add" id="btnAdd">➕ Novo Imóvel</a>
		</div>

		<div style="background:#eee; padding:5px; text-align:center;">
			<small style="cursor:pointer; color:red;" onclick="logout()">Sair / Logout</small>
		</div>

		<div id="lista" class="list-container">
			<p style="text-align:center; color:#777; margin-top:50px;">A carregar imóveis...</p>
		</div>
	</div>

	<div id="map"></div>

	<script>
		window.addEventListener('DOMContentLoaded', () => {
			let role = localStorage.getItem('role');
			role = String(role || "").trim().toLowerCase();
			console.log("Role na lista: " + role);

			if (role === 'client') {
				const btn = document.getElementById('btnAdd');
				if (btn) btn.style.display = 'none';
			}
		});

		function logout() {
			localStorage.clear();
			window.location.href = "Login.html";
		}

        const API_URL = "https://imobiliario-api-pires-hmh8ebhbhwf7b4eh.francecentral-01.azurewebsites.net/api/Property";

		var map = L.map('map').setView([41.5316, -8.6190], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

		async function carregarImoveis() {

			const token = localStorage.getItem('token');
			try {
				const res = await fetch(API_URL, {
					method: 'GET',
					headers: {
						'Authorization': 'Bearer ' + token
					}
				});

				if (!res.ok) throw new Error("Erro API");
				const casas = await res.json();

				const divLista = document.getElementById('lista');
				divLista.innerHTML = "";

				if (casas.length === 0) {
					divLista.innerHTML = "<p style='text-align:center; margin-top:20px'>Nenhum imóvel encontrado.</p>";
					return;
				}

				casas.forEach(casa => {
					const el = document.createElement('div');
					el.className = 'card';
					el.innerHTML = `
									<div style="overflow:hidden; margin-bottom:5px;">
										<span class="tag-type">${casa.Type || 'Imóvel'}</span>
										<span class="card-price">${casa.Price ? casa.Price.toLocaleString() : 0} €</span>
									</div>

									<div style="font-size:16px; font-weight:bold; color:#007bff;">${casa.Name || 'Sem Título'}</div>

									<div class="card-addr" style="font-size:13px; color:#555;">📍 ${casa.Address}</div>

									<div class="card-meta">
										<span>📅 ${casa.YearBuilt}</span>
										<span>📏 ${casa.Area} m²</span>
									</div>
								`;
					el.onclick = () => {
						if (casa.Latitude && casa.Longitude) map.flyTo([casa.Latitude, casa.Longitude], 16);
					};
					divLista.appendChild(el);

					if (casa.Latitude && casa.Longitude) {
						L.marker([casa.Latitude, casa.Longitude]).addTo(map)
							.bindPopup(`<b>${casa.Type}</b><br>${casa.Price} €`);
					}
				});
			} catch (e) {
				console.error(e);
				document.getElementById('lista').innerHTML = "<p style='color:red; text-align:center'>Erro ao carregar dados.</p>";
			}
		}
		carregarImoveis();
	</script>
</body>
</html>